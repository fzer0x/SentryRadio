package dev.fzer0x.imsicatcherdetector2.security

import java.text.SimpleDateFormat
import java.util.Locale

object VulnerabilityMatcher {

    fun isChipsetAffected(description: String, deviceChipset: String): Boolean {
        val desc = description.lowercase()
        val chip = deviceChipset.lowercase()

        if (desc.contains(chip)) return true

        val commonNames = mapOf(
            "sm8550" to listOf("snapdragon 8 gen 2", "qualcomm"),
            "sm8450" to listOf("snapdragon 8 gen 1", "qualcomm"),
            "sm8350" to listOf("snapdragon 888", "qualcomm"),
            "mt6895" to listOf("dimensity 8100", "mediatek"),
            "mt6893" to listOf("dimensity 1200", "mediatek"),
            "exynos2400" to listOf("s5e9945", "samsung", "exynos"),
            "exynos2100" to listOf("s5e9840", "samsung", "exynos")
        )

        commonNames[chip]?.forEach { alias ->
            if (desc.contains(alias)) return true
        }

        return false
    }

    fun isVulnerable(cve: CveEntry, securityPatch: String): Boolean {
        val patchDate = try {
            SimpleDateFormat("yyyy-MM", Locale.US).parse(securityPatch)?.time ?: 0L
        } catch (e: Exception) { 0L }

        return cve.publishedDate > patchDate
    }
}
